<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Busca com texto e OCR em PDF</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 6px; font-size: 1em; margin-top: 5px; }
    #resultado { margin-top: 20px; white-space: pre-line; }
  </style>
</head>
<body>
  <h2>Buscar texto (nativo + OCR opcional) em PDF</h2>

  <label for="fileInput">Escolha o arquivo PDF:</label><br>
  <input type="file" id="fileInput" accept="application/pdf"><br><br>

  <label for="termosInput">Termos a buscar (separados por v√≠rgula):</label><br>
  <input type="text" id="termosInput" placeholder="Ex: sa√∫de, dados, hospital" size="50"><br><br>

  <label><input type="checkbox" id="usarOcr" checked> Usar OCR se texto n√£o for encontrado</label><br><br>

  <button id="buscarBtn">Buscar</button>
  <button id="exportarBtn" disabled>Exportar PDF com p√°ginas encontradas</button>

  <div id="resultado"></div>

  <!-- Bibliotecas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

  <script>
    let paginasEncontradas = [];
    let arquivoOriginal = null;

    document.getElementById('buscarBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const termosInput = document.getElementById('termosInput');
      const usarOcr = document.getElementById('usarOcr').checked;
      const resultadoDiv = document.getElementById('resultado');
      const exportarBtn = document.getElementById('exportarBtn');

      exportarBtn.disabled = true;
      resultadoDiv.innerText = "üîÑ Processando PDF...";

      if (!fileInput.files.length) {
        alert("Selecione um arquivo PDF.");
        return;
      }

      const termos = termosInput.value
        .split(',')
        .map(t => t.trim().toLowerCase())
        .filter(t => t.length > 0);

      if (termos.length === 0) {
        alert("Informe pelo menos um termo para buscar.");
        return;
      }

      const file = fileInput.files[0];
      arquivoOriginal = file;
      const fileReader = new FileReader();

      fileReader.onload = async function () {
        const typedarray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;

        const resultado = {};
        termos.forEach(t => resultado[t] = []);
        const paginasSet = new Set();
        const paginasNaoEncontradas = [];

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          resultadoDiv.innerText = `üìÑ Verificando texto da p√°gina ${pageNum} de ${pdf.numPages}...`;

          const page = await pdf.getPage(pageNum);
          const content = await page.getTextContent();
          const texto = content.items.map(item => item.str).join(" ").toLowerCase();

          let encontrou = false;

          termos.forEach(termo => {
            if (texto.includes(termo)) {
              resultado[termo].push(pageNum);
              paginasSet.add(pageNum);
              encontrou = true;
            }
          });

          if (!encontrou) {
            paginasNaoEncontradas.push({ pageNum, page });
          }
        }

        // OCR nas p√°ginas que n√£o tiveram texto nativo
        if (usarOcr) {
          for (const { pageNum, page } of paginasNaoEncontradas) {
            resultadoDiv.innerText = `üîé Aplicando OCR na p√°gina ${pageNum}...`;

            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const context = canvas.getContext('2d');
            await page.render({ canvasContext: context, viewport }).promise;

            const { data: { text } } = await Tesseract.recognize(canvas, 'por', {
              logger: m => console.log(`OCR p√°g. ${pageNum}: ${m.status}`)
            });

            const textoOCR = text.toLowerCase();
            termos.forEach(termo => {
              if (textoOCR.includes(termo)) {
                resultado[termo].push(pageNum);
                paginasSet.add(pageNum);
              }
            });
          }
        }

        paginasEncontradas = Array.from(paginasSet).sort((a, b) => a - b);
        exportarBtn.disabled = paginasEncontradas.length === 0;

        // Exibir resultado
        let textoResultado = `‚úÖ Resultado da busca:\n\n`;
        for (const termo of termos) {
          const paginas = resultado[termo];
          textoResultado += `üîç "${termo}": ${paginas.length ? 'p√°ginas ' + paginas.join(', ') : 'nenhuma p√°gina encontrada'}\n`;
        }
        if (paginasEncontradas.length > 0) {
          textoResultado += `\nüìÅ Total de p√°ginas a exportar: ${paginasEncontradas.length}`;
        } else {
          textoResultado += `\n‚ö†Ô∏è Nenhuma p√°gina encontrada para exportar.`;
        }

        resultadoDiv.innerText = textoResultado;
      };

      fileReader.readAsArrayBuffer(file);
    });

    document.getElementById('exportarBtn').addEventListener('click', async () => {
      if (!arquivoOriginal || paginasEncontradas.length === 0) {
        alert("Nada para exportar.");
        return;
      }

      const originalBytes = await arquivoOriginal.arrayBuffer();
      const pdfDocOrig = await PDFLib.PDFDocument.load(originalBytes);
      const novoPdf = await PDFLib.PDFDocument.create();

      const paginas = await novoPdf.copyPages(pdfDocOrig, paginasEncontradas.map(p => p - 1));
      paginas.forEach(p => novoPdf.addPage(p));

      const pdfBytes = await novoPdf.save();

      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "pdf_filtrado_ocr.pdf";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
